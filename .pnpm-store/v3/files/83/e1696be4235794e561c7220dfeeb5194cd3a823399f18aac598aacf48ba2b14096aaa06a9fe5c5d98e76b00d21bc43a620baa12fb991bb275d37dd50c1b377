{"version":3,"names":["declare","api","assertVersion","yieldStarVisitor","traverse","visitors","merge","ArrowFunctionExpression","path","skip","YieldExpression","node","state","delegate","asyncIter","t","callExpression","addHelper","argument","environmentVisitor","forAwaitVisitor","ForOfStatement","file","await","build","rewriteForAwait","getAsyncIterator","declar","loop","block","body","ensureBlock","push","inherits","replaceParent","parentPath","replaceWithMultiple","visitor","Function","async","generator","remapAsyncToGenerator","wrapAsync","wrapAwait","name","syntaxAsyncGenerators","default","Program"],"sources":["../src/index.ts"],"sourcesContent":["import { declare } from \"@babel/helper-plugin-utils\";\nimport remapAsyncToGenerator from \"@babel/helper-remap-async-to-generator\";\nimport syntaxAsyncGenerators from \"@babel/plugin-syntax-async-generators\";\nimport type { NodePath, Visitor } from \"@babel/traverse\";\nimport { traverse, types as t, type PluginPass } from \"@babel/core\";\nimport rewriteForAwait from \"./for-await\";\nimport environmentVisitor from \"@babel/helper-environment-visitor\";\n\nexport default declare(api => {\n  api.assertVersion(7);\n\n  const yieldStarVisitor = traverse.visitors.merge<PluginPass>([\n    {\n      ArrowFunctionExpression(path) {\n        path.skip();\n      },\n\n      YieldExpression({ node }, state) {\n        if (!node.delegate) return;\n        const asyncIter = t.callExpression(state.addHelper(\"asyncIterator\"), [\n          node.argument,\n        ]);\n        node.argument = t.callExpression(\n          state.addHelper(\"asyncGeneratorDelegate\"),\n          process.env.BABEL_8_BREAKING\n            ? [asyncIter]\n            : [asyncIter, state.addHelper(\"awaitAsyncGenerator\")],\n        );\n      },\n    },\n    environmentVisitor,\n  ]);\n\n  const forAwaitVisitor = traverse.visitors.merge<PluginPass>([\n    {\n      ArrowFunctionExpression(path) {\n        path.skip();\n      },\n\n      ForOfStatement(path: NodePath<t.ForOfStatement>, { file }) {\n        const { node } = path;\n        if (!node.await) return;\n\n        const build = rewriteForAwait(path, {\n          getAsyncIterator: file.addHelper(\"asyncIterator\"),\n        });\n\n        const { declar, loop } = build;\n        const block = loop.body as t.BlockStatement;\n\n        // ensure that it's a block so we can take all its statements\n        path.ensureBlock();\n\n        // add the value declaration to the new loop body\n        if (declar) {\n          block.body.push(declar);\n        }\n\n        // push the rest of the original loop body onto our new body\n        block.body.push(...path.node.body.body);\n\n        t.inherits(loop, node);\n        t.inherits(loop.body, node.body);\n\n        if (build.replaceParent) {\n          path.parentPath.replaceWithMultiple(build.node);\n        } else {\n          path.replaceWithMultiple(build.node);\n        }\n      },\n    },\n    environmentVisitor,\n  ]);\n\n  const visitor: Visitor<PluginPass> = {\n    Function(path, state) {\n      if (!path.node.async) return;\n\n      path.traverse(forAwaitVisitor, state);\n\n      if (!path.node.generator) return;\n\n      path.traverse(yieldStarVisitor, state);\n\n      // We don't need to pass the noNewArrows assumption, since\n      // async generators are never arrow functions.\n      remapAsyncToGenerator(path, {\n        wrapAsync: state.addHelper(\"wrapAsyncGenerator\"),\n        wrapAwait: state.addHelper(\"awaitAsyncGenerator\"),\n      });\n    },\n  };\n\n  return {\n    name: \"proposal-async-generator-functions\",\n    inherits: syntaxAsyncGenerators.default,\n\n    visitor: {\n      Program(path, state) {\n        // We need to traverse the ast here (instead of just vising Function\n        // in the top level visitor) because for-await needs to run before the\n        // async-to-generator plugin. This is because for-await is transpiled\n        // using \"await\" expressions, which are then converted to \"yield\".\n        //\n        // This is bad for performance, but plugin ordering will allow as to\n        // directly visit Function in the top level visitor.\n        path.traverse(visitor, state);\n      },\n    },\n  };\n});\n"],"mappings":"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"}