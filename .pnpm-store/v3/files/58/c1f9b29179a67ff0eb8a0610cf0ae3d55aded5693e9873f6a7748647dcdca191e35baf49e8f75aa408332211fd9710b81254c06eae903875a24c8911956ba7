import F,{createContext as $,createRef as pe,useContext as Y,useEffect as U,useMemo as h,useReducer as Pe,useRef as q,useState as de}from"react";import{match as G}from'../../utils/match.js';import{forwardRefWithAs as W,render as j,Features as z}from'../../utils/render.js';import{optionalRef as ve,useSyncRefs as k}from'../../hooks/use-sync-refs.js';import{useId as _}from'../../hooks/use-id.js';import{Keys as x}from'../keyboard.js';import{isDisabledReactIssue7711 as se}from'../../utils/bugs.js';import{getFocusableElements as ie,Focus as w,focusIn as N,isFocusableElement as Te,FocusableMode as me}from'../../utils/focus-management.js';import{OpenClosedProvider as ye,State as J,useOpenClosed as ue}from'../../internal/open-closed.js';import{useResolveButtonType as Ee}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as Se}from'../../hooks/use-outside-click.js';import{getOwnerDocument as be}from'../../utils/owner.js';import{useOwnerDocument as X}from'../../hooks/use-owner.js';import{useEventListener as ge}from'../../hooks/use-event-listener.js';import{Hidden as Z,Features as ee}from'../../internal/hidden.js';import{useEvent as b}from'../../hooks/use-event.js';import{useTabDirection as fe,Direction as K}from'../../hooks/use-tab-direction.js';import'../../utils/micro-task.js';var Ae=(f=>(f[f.Open=0]="Open",f[f.Closed=1]="Closed",f))(Ae||{}),Ce=(n=>(n[n.TogglePopover=0]="TogglePopover",n[n.ClosePopover=1]="ClosePopover",n[n.SetButton=2]="SetButton",n[n.SetButtonId=3]="SetButtonId",n[n.SetPanel=4]="SetPanel",n[n.SetPanelId=5]="SetPanelId",n))(Ce||{});let Re={[0]:r=>({...r,popoverState:G(r.popoverState,{[0]:1,[1]:0})}),[1](r){return r.popoverState===1?r:{...r,popoverState:1}},[2](r,t){return r.button===t.button?r:{...r,button:t.button}},[3](r,t){return r.buttonId===t.buttonId?r:{...r,buttonId:t.buttonId}},[4](r,t){return r.panel===t.panel?r:{...r,panel:t.panel}},[5](r,t){return r.panelId===t.panelId?r:{...r,panelId:t.panelId}}},te=$(null);te.displayName="PopoverContext";function Q(r){let t=Y(te);if(t===null){let f=new Error(`<${r} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(f,Q),f}return t}let oe=$(null);oe.displayName="PopoverAPIContext";function re(r){let t=Y(oe);if(t===null){let f=new Error(`<${r} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(f,re),f}return t}let ne=$(null);ne.displayName="PopoverGroupContext";function ce(){return Y(ne)}let le=$(null);le.displayName="PopoverPanelContext";function Oe(){return Y(le)}function Me(r,t){return G(t.type,Re,r,t)}let Le="div",Ie=W(function(t,f){var O;let o=`headlessui-popover-button-${_()}`,v=`headlessui-popover-panel-${_()}`,a=q(null),n=k(f,ve(e=>{a.current=e})),g=Pe(Me,{popoverState:1,button:null,buttonId:o,panel:null,panelId:v,beforePanelSentinel:pe(),afterPanelSentinel:pe()}),[{popoverState:y,button:l,panel:P,beforePanelSentinel:s,afterPanelSentinel:B},i]=g,T=X((O=a.current)!=null?O:l);U(()=>i({type:3,buttonId:o}),[o,i]),U(()=>i({type:5,panelId:v}),[v,i]);let c=h(()=>{if(!l||!P)return!1;for(let M of document.querySelectorAll("body > *"))if(Number(M==null?void 0:M.contains(l))^Number(M==null?void 0:M.contains(P)))return!0;let e=ie(),p=e.indexOf(l),m=(p+e.length-1)%e.length,C=(p+1)%e.length,D=e[m],V=e[C];return!P.contains(D)&&!P.contains(V)},[l,P]),d=h(()=>({buttonId:o,panelId:v,close:()=>i({type:1})}),[o,v,i]),E=ce(),A=E==null?void 0:E.registerPopover,L=b(()=>{var e;return(e=E==null?void 0:E.isFocusWithinPopoverGroup())!=null?e:(T==null?void 0:T.activeElement)&&((l==null?void 0:l.contains(T.activeElement))||(P==null?void 0:P.contains(T.activeElement)))});U(()=>A==null?void 0:A(d),[A,d]),ge(T==null?void 0:T.defaultView,"focus",e=>{var p,m,C,D;y===0&&(L()||!l||!P||(m=(p=s.current)==null?void 0:p.contains)!=null&&m.call(p,e.target)||(D=(C=B.current)==null?void 0:C.contains)!=null&&D.call(C,e.target)||i({type:1}))},!0),Se([l,P],(e,p)=>{i({type:1}),Te(p,me.Loose)||(e.preventDefault(),l==null||l.focus())},y===0);let I=b(e=>{i({type:1});let p=(()=>e?e instanceof HTMLElement?e:"current"in e&&e.current instanceof HTMLElement?e.current:l:l)();p==null||p.focus()}),H=h(()=>({close:I,isPortalled:c}),[I,c]),u=h(()=>({open:y===0,close:I}),[y,I]),S=t,R={ref:n};return F.createElement(te.Provider,{value:g},F.createElement(oe.Provider,{value:H},F.createElement(ye,{value:G(y,{[0]:J.Open,[1]:J.Closed})},j({ourProps:R,theirProps:S,slot:u,defaultTag:Le,name:"Popover"}))))}),Fe="button",he=W(function(t,f){let[o,v]=Q("Popover.Button"),{isPortalled:a}=re("Popover.Button"),n=q(null),g=`headlessui-focus-sentinel-${_()}`,y=ce(),l=y==null?void 0:y.closeOthers,P=Oe(),s=P===null?!1:P===o.panelId,B=k(n,f,s?null:e=>v({type:2,button:e})),i=k(n,f),T=X(n),c=b(e=>{var p,m,C;if(s){if(o.popoverState===1)return;switch(e.key){case x.Space:case x.Enter:e.preventDefault(),(m=(p=e.target).click)==null||m.call(p),v({type:1}),(C=o.button)==null||C.focus();break}}else switch(e.key){case x.Space:case x.Enter:e.preventDefault(),e.stopPropagation(),o.popoverState===1&&(l==null||l(o.buttonId)),v({type:0});break;case x.Escape:if(o.popoverState!==0)return l==null?void 0:l(o.buttonId);if(!n.current||(T==null?void 0:T.activeElement)&&!n.current.contains(T.activeElement))return;e.preventDefault(),e.stopPropagation(),v({type:1});break}}),d=b(e=>{s||e.key===x.Space&&e.preventDefault()}),E=b(e=>{var p,m;se(e.currentTarget)||t.disabled||(s?(v({type:1}),(p=o.button)==null||p.focus()):(e.preventDefault(),e.stopPropagation(),o.popoverState===1&&(l==null||l(o.buttonId)),v({type:0}),(m=o.button)==null||m.focus()))}),A=b(e=>{e.preventDefault(),e.stopPropagation()}),L=o.popoverState===0,I=h(()=>({open:L}),[L]),H=Ee(t,n),u=t,S=s?{ref:i,type:H,onKeyDown:c,onClick:E}:{ref:B,id:o.buttonId,type:H,"aria-expanded":t.disabled?void 0:o.popoverState===0,"aria-controls":o.panel?o.panelId:void 0,onKeyDown:c,onKeyUp:d,onClick:E,onMouseDown:A},R=fe(),O=b(()=>{let e=o.panel;if(!e)return;function p(){G(R.current,{[K.Forwards]:()=>N(e,w.First),[K.Backwards]:()=>N(e,w.Last)})}p()});return F.createElement(F.Fragment,null,j({ourProps:S,theirProps:u,slot:I,defaultTag:Fe,name:"Popover.Button"}),L&&!s&&a&&F.createElement(Z,{id:g,features:ee.Focusable,as:"button",type:"button",onFocus:O}))}),Be="div",De=z.RenderStrategy|z.Static,xe=W(function(t,f){let[{popoverState:o},v]=Q("Popover.Overlay"),a=k(f),n=`headlessui-popover-overlay-${_()}`,g=ue(),y=(()=>g!==null?g===J.Open:o===0)(),l=b(i=>{if(se(i.currentTarget))return i.preventDefault();v({type:1})}),P=h(()=>({open:o===0}),[o]);return j({ourProps:{ref:a,id:n,"aria-hidden":!0,onClick:l},theirProps:t,slot:P,defaultTag:Be,features:De,visible:y,name:"Popover.Overlay"})}),He="div",Ge=z.RenderStrategy|z.Static,ke=W(function(t,f){let{focus:o=!1,...v}=t,[a,n]=Q("Popover.Panel"),{close:g,isPortalled:y}=re("Popover.Panel"),l=`headlessui-focus-sentinel-before-${_()}`,P=`headlessui-focus-sentinel-after-${_()}`,s=q(null),B=k(s,f,u=>{n({type:4,panel:u})}),i=X(s),T=ue(),c=(()=>T!==null?T===J.Open:a.popoverState===0)(),d=b(u=>{var S;switch(u.key){case x.Escape:if(a.popoverState!==0||!s.current||(i==null?void 0:i.activeElement)&&!s.current.contains(i.activeElement))return;u.preventDefault(),u.stopPropagation(),n({type:1}),(S=a.button)==null||S.focus();break}});U(()=>{var u;t.static||a.popoverState===1&&((u=t.unmount)!=null?u:!0)&&n({type:4,panel:null})},[a.popoverState,t.unmount,t.static,n]),U(()=>{if(!o||a.popoverState!==0||!s.current)return;let u=i==null?void 0:i.activeElement;s.current.contains(u)||N(s.current,w.First)},[o,s,a.popoverState]);let E=h(()=>({open:a.popoverState===0,close:g}),[a,g]),A={ref:B,id:a.panelId,onKeyDown:d,onBlur:o&&a.popoverState===0?u=>{var R,O,e,p,m;let S=u.relatedTarget;!S||!s.current||(R=s.current)!=null&&R.contains(S)||(n({type:1}),(((e=(O=a.beforePanelSentinel.current)==null?void 0:O.contains)==null?void 0:e.call(O,S))||((m=(p=a.afterPanelSentinel.current)==null?void 0:p.contains)==null?void 0:m.call(p,S)))&&S.focus({preventScroll:!0}))}:void 0,tabIndex:-1},L=fe(),I=b(()=>{let u=s.current;if(!u)return;function S(){G(L.current,{[K.Forwards]:()=>{N(u,w.First)},[K.Backwards]:()=>{var R;(R=a.button)==null||R.focus({preventScroll:!0})}})}S()}),H=b(()=>{let u=s.current;if(!u)return;function S(){G(L.current,{[K.Forwards]:()=>{var C,D,V;if(!a.button)return;let R=ie(),O=R.indexOf(a.button),e=R.slice(0,O+1),m=[...R.slice(O+1),...e];for(let M of m.slice())if(((D=(C=M==null?void 0:M.id)==null?void 0:C.startsWith)==null?void 0:D.call(C,"headlessui-focus-sentinel-"))||((V=a.panel)==null?void 0:V.contains(M))){let ae=m.indexOf(M);ae!==-1&&m.splice(ae,1)}N(m,w.First,!1)},[K.Backwards]:()=>N(u,w.Last)})}S()});return F.createElement(le.Provider,{value:a.panelId},c&&y&&F.createElement(Z,{id:l,ref:a.beforePanelSentinel,features:ee.Focusable,as:"button",type:"button",onFocus:I}),j({ourProps:A,theirProps:v,slot:E,defaultTag:He,features:Ge,visible:c,name:"Popover.Panel"}),c&&y&&F.createElement(Z,{id:P,ref:a.afterPanelSentinel,features:ee.Focusable,as:"button",type:"button",onFocus:H}))}),_e="div",we=W(function(t,f){let o=q(null),v=k(o,f),[a,n]=de([]),g=b(c=>{n(d=>{let E=d.indexOf(c);if(E!==-1){let A=d.slice();return A.splice(E,1),A}return d})}),y=b(c=>(n(d=>[...d,c]),()=>g(c))),l=b(()=>{var E;let c=be(o);if(!c)return!1;let d=c.activeElement;return(E=o.current)!=null&&E.contains(d)?!0:a.some(A=>{var L,I;return((L=c.getElementById(A.buttonId))==null?void 0:L.contains(d))||((I=c.getElementById(A.panelId))==null?void 0:I.contains(d))})}),P=b(c=>{for(let d of a)d.buttonId!==c&&d.close()}),s=h(()=>({registerPopover:y,unregisterPopover:g,isFocusWithinPopoverGroup:l,closeOthers:P}),[y,g,l,P]),B=h(()=>({}),[]),i=t,T={ref:v};return F.createElement(ne.Provider,{value:s},j({ourProps:T,theirProps:i,slot:B,defaultTag:_e,name:"Popover.Group"}))}),mt=Object.assign(Ie,{Button:he,Overlay:xe,Panel:ke,Group:we});export{mt as Popover};
