{"version":3,"file":"index.development.js","sources":["../../src/index.ts"],"sourcesContent":["import {\n  PersistedClient,\n  Persister,\n  PersistRetryer,\n} from '@tanstack/react-query-persist-client'\n\ninterface Storage {\n  getItem: (key: string) => string | null\n  setItem: (key: string, value: string) => void\n  removeItem: (key: string) => void\n}\n\ninterface CreateSyncStoragePersisterOptions {\n  /** The storage client used for setting and retrieving items from cache.\n   * For SSR pass in `undefined`.\n   */\n  storage: Storage | undefined\n  /** The key to use when storing the cache */\n  key?: string\n  /** To avoid spamming,\n   * pass a time in ms to throttle saving the cache to disk */\n  throttleTime?: number\n  /**\n   * How to serialize the data to storage.\n   * @default `JSON.stringify`\n   */\n  serialize?: (client: PersistedClient) => string\n  /**\n   * How to deserialize the data from storage.\n   * @default `JSON.parse`\n   */\n  deserialize?: (cachedString: string) => PersistedClient\n\n  retry?: PersistRetryer\n}\n\nexport function createSyncStoragePersister({\n  storage,\n  key = `REACT_QUERY_OFFLINE_CACHE`,\n  throttleTime = 1000,\n  serialize = JSON.stringify,\n  deserialize = JSON.parse,\n  retry,\n}: CreateSyncStoragePersisterOptions): Persister {\n  if (typeof storage !== 'undefined') {\n    const trySave = (persistedClient: PersistedClient): Error | undefined => {\n      try {\n        storage.setItem(key, serialize(persistedClient))\n      } catch (error) {\n        return error as Error\n      }\n    }\n    return {\n      persistClient: throttle((persistedClient) => {\n        let client: PersistedClient | undefined = persistedClient\n        let error = trySave(client)\n        let errorCount = 0\n        while (error && client) {\n          errorCount++\n          client = retry?.({\n            persistedClient: client,\n            error,\n            errorCount,\n          })\n\n          if (client) {\n            error = trySave(client)\n          }\n        }\n      }, throttleTime),\n      restoreClient: () => {\n        const cacheString = storage.getItem(key)\n\n        if (!cacheString) {\n          return\n        }\n\n        return deserialize(cacheString) as PersistedClient\n      },\n      removeClient: () => {\n        storage.removeItem(key)\n      },\n    }\n  }\n\n  return {\n    persistClient: noop,\n    restoreClient: () => undefined,\n    removeClient: noop,\n  }\n}\n\nfunction throttle<TArgs extends any[]>(\n  func: (...args: TArgs) => any,\n  wait = 100,\n) {\n  let timer: ReturnType<typeof setTimeout> | null = null\n  let params: TArgs\n  return function (...args: TArgs) {\n    params = args\n    if (timer === null) {\n      timer = setTimeout(() => {\n        func(...params)\n        timer = null\n      }, wait)\n    }\n  }\n}\n\n// eslint-disable-next-line @typescript-eslint/no-empty-function\nfunction noop() {}\n"],"names":["createSyncStoragePersister","storage","key","throttleTime","serialize","JSON","stringify","deserialize","parse","retry","trySave","persistedClient","setItem","error","persistClient","throttle","client","errorCount","restoreClient","cacheString","getItem","removeClient","removeItem","noop","undefined","func","wait","timer","params","args","setTimeout"],"mappings":";;;;;;EAoCO,SAASA,0BAAT,CAAoC;IACzCC,OADyC;EAEzCC,EAAAA,GAAG,GAFsC,2BAAA;EAGzCC,EAAAA,YAAY,GAAG,IAH0B;IAIzCC,SAAS,GAAGC,IAAI,CAACC,SAJwB;IAKzCC,WAAW,GAAGF,IAAI,CAACG,KALsB;EAMzCC,EAAAA,KAAAA;EANyC,CAApC,EAO0C;EAC/C,EAAA,IAAI,OAAOR,OAAP,KAAmB,WAAvB,EAAoC;MAClC,MAAMS,OAAO,GAAIC,eAAD,IAAyD;QACvE,IAAI;UACFV,OAAO,CAACW,OAAR,CAAgBV,GAAhB,EAAqBE,SAAS,CAACO,eAAD,CAA9B,CAAA,CAAA;SADF,CAEE,OAAOE,KAAP,EAAc;EACd,QAAA,OAAOA,KAAP,CAAA;EACD,OAAA;OALH,CAAA;;MAOA,OAAO;EACLC,MAAAA,aAAa,EAAEC,QAAQ,CAAEJ,eAAD,IAAqB;UAC3C,IAAIK,MAAmC,GAAGL,eAA1C,CAAA;EACA,QAAA,IAAIE,KAAK,GAAGH,OAAO,CAACM,MAAD,CAAnB,CAAA;UACA,IAAIC,UAAU,GAAG,CAAjB,CAAA;;UACA,OAAOJ,KAAK,IAAIG,MAAhB,EAAwB;YACtBC,UAAU,EAAA,CAAA;EACVD,UAAAA,MAAM,GAAGP,KAAH,IAAGA,IAAAA,GAAAA,KAAAA,CAAAA,GAAAA,KAAK,CAAG;EACfE,YAAAA,eAAe,EAAEK,MADF;cAEfH,KAFe;EAGfI,YAAAA,UAAAA;EAHe,WAAH,CAAd,CAAA;;EAMA,UAAA,IAAID,MAAJ,EAAY;EACVH,YAAAA,KAAK,GAAGH,OAAO,CAACM,MAAD,CAAf,CAAA;EACD,WAAA;EACF,SAAA;SAfoB,EAgBpBb,YAhBoB,CADlB;EAkBLe,MAAAA,aAAa,EAAE,MAAM;EACnB,QAAA,MAAMC,WAAW,GAAGlB,OAAO,CAACmB,OAAR,CAAgBlB,GAAhB,CAApB,CAAA;;UAEA,IAAI,CAACiB,WAAL,EAAkB;EAChB,UAAA,OAAA;EACD,SAAA;;UAED,OAAOZ,WAAW,CAACY,WAAD,CAAlB,CAAA;SAzBG;EA2BLE,MAAAA,YAAY,EAAE,MAAM;UAClBpB,OAAO,CAACqB,UAAR,CAAmBpB,GAAnB,CAAA,CAAA;EACD,OAAA;OA7BH,CAAA;EA+BD,GAAA;;IAED,OAAO;EACLY,IAAAA,aAAa,EAAES,IADV;MAELL,aAAa,EAAE,MAAMM,SAFhB;EAGLH,IAAAA,YAAY,EAAEE,IAAAA;KAHhB,CAAA;EAKD,CAAA;;EAED,SAASR,QAAT,CACEU,IADF,EAEEC,IAAI,GAAG,GAFT,EAGE;IACA,IAAIC,KAA2C,GAAG,IAAlD,CAAA;EACA,EAAA,IAAIC,MAAJ,CAAA;IACA,OAAO,UAAU,GAAGC,IAAb,EAA0B;EAC/BD,IAAAA,MAAM,GAAGC,IAAT,CAAA;;MACA,IAAIF,KAAK,KAAK,IAAd,EAAoB;QAClBA,KAAK,GAAGG,UAAU,CAAC,MAAM;UACvBL,IAAI,CAAC,GAAGG,MAAJ,CAAJ,CAAA;EACAD,QAAAA,KAAK,GAAG,IAAR,CAAA;SAFgB,EAGfD,IAHe,CAAlB,CAAA;EAID,KAAA;KAPH,CAAA;EASD;;;EAGD,SAASH,IAAT,GAAgB;;;;;;;;;;"}